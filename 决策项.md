# EDR 项目技术决策记录 (ADR)

## 一、Agent 端技术决策

| 决策项 | 决策结果 | 备选方案 | 决策理由 |
|--------|----------|----------|----------|
| **Agent 主语言** | C + Go | Rust | 1) 小团队快速出MVP优先；2) Go开发效率高，招聘容易；3) C性能满足采集需求，复用libyara/libbpf；4) Osquery/Velociraptor/Sysdig验证。⚠️缺点：C部分需代码审计防内存安全问题，CGO有~50ns调用开销 |
| **Go 运行时** | Go 1.21+ | Go 1.18 | GC优化、泛型支持、性能提升 |
| **Windows事件采集** | ETW (C + Win SDK) | WMI, API Hook | 1) 微软官方推荐；2) 性能最优；3) 无需内核驱动 |
| **Linux事件采集** | eBPF (C + libbpf) | Audit, Ftrace | 1) 现代内核标准；2) 性能开销最低；3) LGPL动态链接合规 |
| **macOS事件采集** | Endpoint Security (C/ObjC) | OpenBSM, kauth | Apple官方推荐，API稳定，权限模型清晰 |
| **本地存储** | SQLite (go-sqlite3) | RocksDB, LMDB | 1) 零配置；2) 单文件便携；3) 断网缓存场景足够 |
| **恶意文件检测** | YARA (C libyara + CGO) | ClamAV, 自研 | 1) BSD许可证商业友好；2) 业界事实标准；3) 规则生态丰富 |
| **行为规则引擎** | Sigma (C解析器 + Go管理) | Splunk SPL, KQL | 1) 开放标准MIT许可；2) 规则可跨平台；3) 社区规则3000+ |
| **通信协议** | gRPC + Protobuf (grpc-go) | REST, MQTT | 1) 强类型；2) 双向流支持；3) 二进制高效 |
| **TLS实现** | Go层: crypto/tls; C层: OpenSSL 3.x | rustls, BoringSSL | 1) Go层原生无额外依赖；2) C层用OpenSSL处理证书解析；3) 分层职责清晰 |
| **系统状态查询** | Osquery (osquery-go SDK集成) | 自研采集 | 1) SQL化查询灵活；2) 跨平台统一接口；3) 非核心采集，作为扩展能力 |
| **数据压缩** | zstd (C层) + compress/zlib (Go层) | gzip, lz4 | 1) zstd压缩比和速度平衡最优；2) Go层用标准库减少依赖 |

## 二、Cloud 端技术决策

| 决策项 | 决策结果 | 备选方案 | 决策理由 |
|--------|----------|----------|----------|
| **Cloud 主语言** | Go | Java, Rust | 1) 云原生生态成熟；2) 开发效率高；3) 部署简单 |
| **消息队列** | Apache Kafka | RabbitMQ, Pulsar | 1) 高吞吐持久化；2) 分区保序；3) 10万+Agent验证 |
| **事件存储** | OpenSearch | Elasticsearch, Splunk | 1) Apache许可无License争议；2) 功能对等ES；3) 全文检索能力 |
| **配置存储** | PostgreSQL | MySQL, MongoDB | 1) 行级安全(RLS)支持多租户；2) JSONB灵活；3) 事务ACID |
| **统计分析** | ClickHouse | TimescaleDB, Druid | 1) OLAP性能最优；2) 压缩比高；3) 列式存储适合聚合 |
| **缓存层** | Redis | Memcached, KeyDB | 1) 数据结构丰富；2) Bloom Filter支持；3) IOC匹配场景 |
| **对象存储** | MinIO | S3, Ceph | 1) S3兼容；2) 私有部署；3) Apache许可 |
| **流处理** | Apache Flink | Spark Streaming, Kafka Streams | 1) CEP原生支持；2) 低延迟；3) 状态管理完善 |
| **RBAC引擎** | Casbin | OPA, 自研 | 1) Go原生；2) 多模型支持；3) Apache许可 |
| **API网关** | 自研 (Go) | Kong, APISIX | 减少外部依赖，与gRPC深度集成 |
| **可观测性** | OpenTelemetry | Jaeger SDK, Zipkin | 1) CNCF标准；2) Trace/Metrics/Logs统一；3) 厂商无关 |
| **威胁情报格式** | STIX 2.1 + TAXII | MISP格式, 自定义 | 1) 行业标准；2) 情报交换互通；3) OpenCTI兼容 |

## 三、Console 端技术决策

| 决策项 | 决策结果 | 备选方案 | 决策理由 |
|--------|----------|----------|----------|
| **前端框架** | React 18 | Vue 3, Angular | 1) 生态最成熟；2) TypeScript支持好；3) 团队熟悉 |
| **UI组件库** | Ant Design 5 | Material UI, Arco | 1) 企业级组件全；2) 中文文档；3) 表格/表单强 |
| **构建工具** | Vite | Webpack, Turbopack | 1) 开发体验快；2) ESM原生；3) 配置简单 |
| **状态管理** | Zustand | Redux, MobX | 1) 轻量简洁；2) 无样板代码；3) TypeScript友好 |
| **图表库** | ECharts / Ant Charts | D3.js, Recharts | 1) 开箱即用；2) 交互丰富；3) ATT&CK矩阵支持 |
| **关系图可视化** | @antv/g6 | cytoscape.js, react-flow | 1) 攻击链/进程树可视化；2) AntV生态统一；3) MIT许可 |
| **代码编辑器** | Monaco Editor | CodeMirror, Ace | 1) VSCode同款；2) Sigma/YARA高亮；3) 智能提示 |

## 四、基础设施决策

| 决策项 | 决策结果 | 备选方案 | 决策理由 |
|--------|----------|----------|----------|
| **容器编排** | Kubernetes | Docker Swarm, Nomad | 1) 行业标准；2) 自动扩缩容；3) 云厂商支持 |
| **监控告警** | Prometheus + Grafana | Datadog, Zabbix | 1) 开源免费；2) 云原生集成；3) PromQL强大 |
| **分布式追踪** | Jaeger | Zipkin, SkyWalking | 1) CNCF项目；2) OpenTelemetry兼容；3) 轻量 |
| **日志收集** | Loki | ELK, Fluentd | 1) Grafana原生；2) 标签索引高效；3) 成本低 |
| **CI/CD** | GitHub Actions | GitLab CI, Jenkins | 1) 原生集成；2) 免费额度；3) 矩阵构建 |
| **镜像仓库** | Harbor | Docker Hub, ACR | 1) 私有部署；2) 漏洞扫描；3) RBAC |

## 五、安全相关决策

| 决策项 | 决策结果 | 备选方案 | 决策理由 |
|--------|----------|----------|----------|
| **传输加密** | mTLS (TLS 1.3) | TLS 1.2, 自定义 | 1) 双向认证；2) 防中间人；3) 最新标准 |
| **数据加密** | AES-256-GCM | ChaCha20, 3DES | 1) 硬件加速；2) NIST推荐；3) 认证加密 |
| **密钥管理** | HashiCorp Vault (可选) | 自研, AWS KMS | 1) 开源版够用；2) 动态密钥；3) 审计日志 |
| **身份认证** | JWT + OAuth2 | SAML, Kerberos | 1) 无状态；2) 标准协议；3) 云原生友好 |
| **事件格式** | ECS (Elastic Common Schema) | OCSF, CEF | 1) 最成熟；2) OpenSearch兼容；3) 字段标准化 |

## 六、许可证合规决策

| 组件类型 | 许可要求 | 禁止使用 | 理由 |
|----------|----------|----------|------|
| **直接集成** | Apache 2.0, MIT, BSD | GPL, AGPL | 避免传染性，保护商业代码 |
| **动态链接** | LGPL 可接受 | GPL | 动态链接符合LGPL要求 |
| **云端服务** | Apache 2.0 优先 | SSPL | 避免SaaS场景争议 |
| **开发工具** | 无限制 | - | 工具链不影响产品许可 |

---

## 七、Rust vs Go 完整对比分析（补充）

### 性能基准对比（EDR场景）

| 场景 | Rust | Go | 差异 |
|------|------|----|----|
| 进程事件解析 (1M/s) | 12ms/批 | 18ms/批 | Rust快33% |
| YARA规则扫描 | 原生 | CGO开销 | Rust快40% |
| 内存占用 (常驻) | 15-25MB | 40-80MB | Rust省50%+ |
| 二进制大小 | 3-5MB | 10-15MB | Rust小60% |
| GC暂停 | 无 | 1-10ms | Rust无STW |

### 开发效率对比

| 维度 | Rust | Go |
|------|------|---|
| 初期开发速度 | 慢 (学习曲线) | 快 |
| 长期维护成本 | 低 (编译期保证) | 中 |
| 调试难度 | 中 (生命周期) | 低 |
| 招聘难度 | 高 | 低 |
| 代码行数 | 较多 | 简洁 |

### 最终建议

**推荐 Rust** 的前提条件：
1. 团队有Rust经验或愿意投入学习
2. 对性能和资源占用有严格要求
3. 项目周期允许初期较慢的开发速度

**可考虑 Go** 的场景：
1. 团队无Rust经验且时间紧迫
2. 资源占用要求不严格
3. 优先快速上市

---

*决策记录人: AI Assistant*  
*记录时间: 2025-11-29*  
*关联架构文档版本: v38*