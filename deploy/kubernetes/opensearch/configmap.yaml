apiVersion: v1
kind: ConfigMap
metadata:
  name: opensearch-config
  namespace: opensearch
  labels:
    app.kubernetes.io/name: opensearch
data:
  opensearch.yml: |
    cluster.name: edr-cluster
    node.name: ${HOSTNAME}
    
    # 单节点开发模式配置
    discovery.type: single-node
    
    # 网络配置
    network.host: 0.0.0.0
    http.port: 9200
    transport.port: 9300
    
    # 路径配置
    path.data: /usr/share/opensearch/data
    path.logs: /usr/share/opensearch/logs
    
    # 安全配置
    plugins.security.ssl.transport.pemcert_filepath: certs/node.pem
    plugins.security.ssl.transport.pemkey_filepath: certs/node-key.pem
    plugins.security.ssl.transport.pemtrustedcas_filepath: certs/root-ca.pem
    plugins.security.ssl.transport.enforce_hostname_verification: false
    plugins.security.ssl.http.enabled: true
    plugins.security.ssl.http.pemcert_filepath: certs/node.pem
    plugins.security.ssl.http.pemkey_filepath: certs/node-key.pem
    plugins.security.ssl.http.pemtrustedcas_filepath: certs/root-ca.pem
    plugins.security.allow_unsafe_democertificates: true
    plugins.security.allow_default_init_securityindex: true
    
    # 内存配置
    bootstrap.memory_lock: false
    
    # 禁用不需要的插件 (可选)
    # plugins.security.disabled: true
  
  jvm.options: |
    # JVM 堆大小设置
    -Xms4g
    -Xmx4g
    
    # GC 配置
    -XX:+UseG1GC
    -XX:G1HeapRegionSize=8m
    -XX:InitiatingHeapOccupancyPercent=75
    
    # GC 日志
    -Xlog:gc*,gc+age=trace,safepoint:file=/usr/share/opensearch/logs/gc.log:utctime,pid,tags:filecount=32,filesize=64m
    
    # 性能调优
    -XX:+HeapDumpOnOutOfMemoryError
    -XX:HeapDumpPath=/usr/share/opensearch/data
    -XX:ErrorFile=/usr/share/opensearch/logs/hs_err_pid%p.log
    
    # 安全
    -Djava.security.policy=/usr/share/opensearch/config/opensearch-performance-analyzer/opensearch_security.policy
